{% extends 'base.html' %}

{% block page_header %}Macro {{ macro_name }}{% endblock %}

{% block page_body %}
  <div id="pkg-file-list" class= "col-md-3 btn-group-vertical" role="group"
       aria-label="List of files defining this macro">
       <h3>Macro Defined In...</h3>
      {% for macro in macros %}
      <button type="button" class="btn btn-default btn-pick-one">
        {{ macro.source.pkg.name }} [{{ macro.source.pkg.version }}]
        <br>
        {{ macro.source.file_path }}
      </button>
      {% endfor %}
  </div>
  <div id="macro-defn" class="col-md-6">
    <h3>Macro Definition</h3>
    <div id="macro-code-display" class="source-code"></div>
  </div>
  <div id="right-side" class="col-md-3">
    <h3>References Found</h3>
    <div id="macro-ref-display"></div>
    <p class="annotation">Note: when there are multiple definitions of a macro, currently there
    is no way to determine which definition is in effect for each reference.</p>
  </div>
</div>

{% endblock %}

{% block javascript_libraries %}
<script>(function () {
  "use strict";

  var macro_name = "{{ macro_name }}";

  $("#pkg-file-list button").on("click", function () {
    var pkg_selected, match, pkg_name, pkg_version, filename;

    pkg_selected = this.innerHTML.trim();
    match = /([^\ ]+)\ \[([0-9.]+)\].*/.exec(pkg_selected);
    pkg_name = match[1];
    pkg_version = match[2];
    console.log(pkg_name, pkg_version);
    match = /.*<br>\n(.+)/.exec(pkg_selected);
    filename = match[1].trim();
    console.log(filename);
    $.ajax({
      url: "/files/api/macro_defs/" + macro_name + "/" + pkg_name + "/" + pkg_version + "/",
      success: function (data) {
          var macro_id, macro_def;

          macro_def = $.parseJSON(data);
          macro_id = macro_def[0].id;
          console.log("macro ID is " + macro_id);
          $.ajax({
            url: "/files/api/macro_def_text/" + macro_id + "/",
            success: function (data) {
                var lines;
                $("#macro-code-display pre").remove();

                // lines = data.split("\n");
                $("#macro-code-display").append("<pre>" + data.replace("\t", "  ") + "</pre>");

                //lines.forEach(function (line) {
                //  $("#macro-code-display").append(line);
                //});

              } // success
          }); // $.ajax
        } // success
    }); // $.ajax
  }); //.on("click"
}).call(this);
</script>
{% endblock %}
